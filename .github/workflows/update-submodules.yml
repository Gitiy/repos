name: Update Submodules from repos.txt

on:
  schedule:
    - cron: '0 0 * * *'  # ÊØèÂ§© UTC 00:00 ËøêË°å
  workflow_dispatch:     # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ÂøÖÈ°ªÂÖÅËÆ∏ push

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          submodules: false  # ÂÖà‰∏çÂàùÂßãÂåñÂ≠êÊ®°Âùó

      - name: Setup Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Initialize .gitmodules if missing
        run: |
          if [ ! -f .gitmodules ]; then
            touch .gitmodules
            git add .gitmodules
            git commit -m "chore: init .gitmodules" || true
          fi

      - name: Process repos.txt and manage submodules
        run: |
          mkdir -p modules

          # ÂÖºÂÆπ Windows Êç¢Ë°åÁ¨¶
          sed -i 's/\r$//' repos.txt

          while IFS= read -r line || [[ -n "$line" ]]; do
            # ÂéªÈô§È¶ñÂ∞æÁ©∫ÁôΩ
            trimmed=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            # Ë∑≥ËøáÁ©∫Ë°åÂíåÊ≥®Èáä
            if [[ -z "$trimmed" || "$trimmed" == \#* ]]; then
              continue
            fi

            # ÊèêÂèñ URL ÂíåÂèØÈÄâË∑ØÂæÑ
            url=$(echo "$trimmed" | awk '{print $1}')
            custom_path=$(echo "$trimmed" | awk 'NF>=2 {print $2}')

            # Ë∑≥ËøáÊòéÊòæÊó†ÊïàÁöÑ URL
            if [[ -z "$url" || "$url" == "https://" || "$url" == "http://" ]]; then
              echo "‚ö†Ô∏è Skipping invalid line: '$line'"
              continue
            fi

            if [[ -z "$custom_path" ]]; then
              repo_name=$(basename "$url" .git)
              local_path="modules/$repo_name"
            else
              local_path="$custom_path"
              mkdir -p "$(dirname "$local_path")"
            fi

            # Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if grep -q "path = $local_path" .gitmodules 2>/dev/null; then
              echo "üîÑ Updating existing submodule: $local_path"
              (
                cd "$local_path" && git fetch origin && git checkout $(git rev-parse --abbrev-ref HEAD) || echo "‚ö†Ô∏è Failed to update $local_path"
              )
            else
              echo "‚ûï Adding new submodule: $url -> $local_path"
              git submodule add --force "$url" "$local_path" || echo "‚ùå Failed to add $url"
            fi
          done < repos.txt

      - name: Commit and push if changed
        run: |
          # Á°Æ‰øù modules/ ÁõÆÂΩïÂ≠òÂú®ÔºàÈò≤Ê≠¢ git add Êä•ÈîôÔºâ
          mkdir -p modules

          git add .gitmodules
          git add modules/ 2>/dev/null || true

          if ! git diff --cached --quiet; then
            git commit -m "chore: sync submodules from repos.txt"
            git push
            echo "‚úÖ Changes pushed."
          else
            echo "‚ÑπÔ∏è No changes detected."
          fi
